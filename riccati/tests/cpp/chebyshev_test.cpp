#include <riccati/solver.hpp>
#include <tests/cpp/utils.hpp>
#include <gtest/gtest.h>
#include <cmath>
#include <fstream>
#include <stdlib.h>
#include <string>

TEST(riccati, chebyshev_coeffs_to_cheby_nodes_truth) {
  Eigen::MatrixXd truth(17, 17);
  truth << 1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,  1.        ,
        1.        ,  0.98078528,  0.92387953,  0.83146961,  0.70710678,  0.55557023,  0.38268343,  0.19509032,  0.        , -0.19509032, -0.38268343, -0.55557023, -0.70710678, -0.83146961, -0.92387953, -0.98078528, -1.        ,
        1.        ,  0.92387953,  0.70710678,  0.38268343,  0.        , -0.38268343, -0.70710678, -0.92387953, -1.        , -0.92387953, -0.70710678, -0.38268343,  0.        ,  0.38268343,  0.70710678,  0.92387953,  1.        ,
        1.        ,  0.83146961,  0.38268343, -0.19509032, -0.70710678, -0.98078528, -0.92387953, -0.55557023,  0.        ,  0.55557023,  0.92387953,  0.98078528,  0.70710678,  0.19509032, -0.38268343, -0.83146961, -1.        ,
        1.        ,  0.70710678,  0.        , -0.70710678, -1.        , -0.70710678,  0.        ,  0.70710678,  1.        ,  0.70710678,  0.        , -0.70710678, -1.        , -0.70710678,  0.        ,  0.70710678,  1.        ,
        1.        ,  0.55557023, -0.38268343, -0.98078528, -0.70710678,  0.19509032,  0.92387953,  0.83146961,  0.        , -0.83146961, -0.92387953, -0.19509032,  0.70710678,  0.98078528,  0.38268343, -0.55557023, -1.        ,
        1.        ,  0.38268343, -0.70710678, -0.92387953,  0.        ,  0.92387953,  0.70710678, -0.38268343, -1.        , -0.38268343,  0.70710678,  0.92387953,  0.        , -0.92387953, -0.70710678,  0.38268343,  1.        ,
        1.        ,  0.19509032, -0.92387953, -0.55557023,  0.70710678,  0.83146961, -0.38268343, -0.98078528,  0.        ,  0.98078528,  0.38268343, -0.83146961, -0.70710678,  0.55557023,  0.92387953, -0.19509032, -1.        ,
        1.        ,  0.        , -1.        ,  0.        ,  1.        ,  0.        , -1.        ,  0.        ,  1.        ,  0.        , -1.        ,  0.        ,  1.        ,  0.        , -1.        ,  0.        ,  1.        ,
        1.        , -0.19509032, -0.92387953,  0.55557023,  0.70710678, -0.83146961, -0.38268343,  0.98078528,  0.        , -0.98078528,  0.38268343,  0.83146961, -0.70710678, -0.55557023,  0.92387953,  0.19509032, -1.        ,
        1.        , -0.38268343, -0.70710678,  0.92387953,  0.        , -0.92387953,  0.70710678,  0.38268343, -1.        ,  0.38268343,  0.70710678, -0.92387953,  0.        ,  0.92387953, -0.70710678, -0.38268343,  1.        ,
        1.        , -0.55557023, -0.38268343,  0.98078528, -0.70710678, -0.19509032,  0.92387953, -0.83146961,  0.        ,  0.83146961, -0.92387953,  0.19509032,  0.70710678, -0.98078528,  0.38268343,  0.55557023, -1.        ,
        1.        , -0.70710678,  0.        ,  0.70710678, -1.        ,  0.70710678,  0.        , -0.70710678,  1.        , -0.70710678,  0.        ,  0.70710678, -1.        ,  0.70710678,  0.        , -0.70710678,  1.        ,
        1.        , -0.83146961,  0.38268343,  0.19509032, -0.70710678,  0.98078528, -0.92387953,  0.55557023,  0.        , -0.55557023,  0.92387953, -0.98078528,  0.70710678, -0.19509032, -0.38268343,  0.83146961, -1.        ,
        1.        , -0.92387953,  0.70710678, -0.38268343,  0.        ,  0.38268343, -0.70710678,  0.92387953, -1.        ,  0.92387953, -0.70710678,  0.38268343,  0.        , -0.38268343,  0.70710678, -0.92387953,  1.        ,
        1.        , -0.98078528,  0.92387953, -0.83146961,  0.70710678, -0.55557023,  0.38268343, -0.19509032,  0.        ,  0.19509032, -0.38268343,  0.55557023, -0.70710678,  0.83146961, -0.92387953,  0.98078528, -1.        ,
        1.        , -1.        ,  1.        , -1.        ,  1.        , -1.        ,  1.        , -1.        ,  1.        , -1.        ,  1.        , -1.        ,  1.        , -1.        ,  1.        , -1.        ,  1.  ;
  Eigen::MatrixXd inp = Eigen::MatrixXd::Identity(17, 17);
  Eigen::MatrixXd result = riccati::coeffs_to_cheby_nodes(inp);
  for (Eigen::Index i = 0; i < truth.size(); ++i) {
    EXPECT_FLOAT_EQ(truth(i), result(i));
  }

}

TEST(riccati, chebyshev_cheby_nodes_to_coeffs_truth) {
  Eigen::MatrixXd truth(17, 17);
  truth <<  0.03125   ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.0625    ,  0.03125   ,
        0.0625    ,  0.12259816,  0.11548494,  0.1039337 ,  0.08838835,  0.06944628,  0.04783543,  0.02438629,  0.        , -0.02438629, -0.04783543, -0.06944628, -0.08838835, -0.1039337 , -0.11548494, -0.12259816, -0.0625    ,
        0.0625    ,  0.11548494,  0.08838835,  0.04783543,  0.        , -0.04783543, -0.08838835, -0.11548494, -0.125     , -0.11548494, -0.08838835, -0.04783543,  0.        ,  0.04783543,  0.08838835,  0.11548494,  0.0625    ,
        0.0625    ,  0.1039337 ,  0.04783543, -0.02438629, -0.08838835, -0.12259816, -0.11548494, -0.06944628,  0.        ,  0.06944628,  0.11548494,  0.12259816,  0.08838835,  0.02438629, -0.04783543, -0.1039337 , -0.0625    ,
        0.0625    ,  0.08838835,  0.        , -0.08838835, -0.125     , -0.08838835,  0.        ,  0.08838835,  0.125     ,  0.08838835,  0.        , -0.08838835, -0.125     , -0.08838835,  0.        ,  0.08838835,  0.0625    ,
        0.0625    ,  0.06944628, -0.04783543, -0.12259816, -0.08838835,  0.02438629,  0.11548494,  0.1039337 ,  0.        , -0.1039337 , -0.11548494, -0.02438629,  0.08838835,  0.12259816,  0.04783543, -0.06944628, -0.0625    ,
        0.0625    ,  0.04783543, -0.08838835, -0.11548494,  0.        ,  0.11548494,  0.08838835, -0.04783543, -0.125     , -0.04783543,  0.08838835,  0.11548494,  0.        , -0.11548494, -0.08838835,  0.04783543,  0.0625    ,
        0.0625    ,  0.02438629, -0.11548494, -0.06944628,  0.08838835,  0.1039337 , -0.04783543, -0.12259816,  0.        ,  0.12259816,  0.04783543, -0.1039337 , -0.08838835,  0.06944628,  0.11548494, -0.02438629, -0.0625    ,
        0.0625    ,  0.        , -0.125     ,  0.        ,  0.125     ,  0.        , -0.125     ,  0.        ,  0.125     ,  0.        , -0.125     ,  0.        ,  0.125     ,  0.        , -0.125     ,  0.        ,  0.0625    ,
        0.0625    , -0.02438629, -0.11548494,  0.06944628,  0.08838835, -0.1039337 , -0.04783543,  0.12259816,  0.        , -0.12259816,  0.04783543,  0.1039337 , -0.08838835, -0.06944628,  0.11548494,  0.02438629, -0.0625    ,
        0.0625    , -0.04783543, -0.08838835,  0.11548494,  0.        , -0.11548494,  0.08838835,  0.04783543, -0.125     ,  0.04783543,  0.08838835, -0.11548494,  0.        ,  0.11548494, -0.08838835, -0.04783543,  0.0625    ,
        0.0625    , -0.06944628, -0.04783543,  0.12259816, -0.08838835, -0.02438629,  0.11548494, -0.1039337 ,  0.        ,  0.1039337 , -0.11548494,  0.02438629,  0.08838835, -0.12259816,  0.04783543,  0.06944628, -0.0625    ,
        0.0625    , -0.08838835,  0.        ,  0.08838835, -0.125     ,  0.08838835,  0.        , -0.08838835,  0.125     , -0.08838835,  0.        ,  0.08838835, -0.125     ,  0.08838835,  0.        , -0.08838835,  0.0625    ,
        0.0625    , -0.1039337 ,  0.04783543,  0.02438629, -0.08838835,  0.12259816, -0.11548494,  0.06944628,  0.        , -0.06944628,  0.11548494, -0.12259816,  0.08838835, -0.02438629, -0.04783543,  0.1039337 , -0.0625    ,
        0.0625    , -0.11548494,  0.08838835, -0.04783543,  0.        ,  0.04783543, -0.08838835,  0.11548494, -0.125     ,  0.11548494, -0.08838835,  0.04783543,  0.        , -0.04783543,  0.08838835, -0.11548494,  0.0625    ,
        0.0625    , -0.12259816,  0.11548494, -0.1039337 ,  0.08838835, -0.06944628,  0.04783543, -0.02438629,  0.        ,  0.02438629, -0.04783543,  0.06944628, -0.08838835,  0.1039337 , -0.11548494,  0.12259816, -0.0625    ,
        0.03125   , -0.0625    ,  0.0625    , -0.0625    ,  0.0625    , -0.0625    ,  0.0625    , -0.0625    ,  0.0625    , -0.0625    ,  0.0625    , -0.0625    ,  0.0625    , -0.0625    ,  0.0625    , -0.0625    ,  0.03125 ;
  Eigen::MatrixXd inp = Eigen::MatrixXd::Identity(17, 17);
  Eigen::MatrixXd result = riccati::cheby_nodes_to_coeffs(inp);
  for (Eigen::Index j = 0; j < truth.cols(); ++j) {
    for (Eigen::Index i = 0; i < truth.rows(); ++i) {
      EXPECT_FLOAT_EQ(truth(i,j), result(i,j));
    }
  }

}
// NOTE: These need transposed since numpy prints out row major order
static constexpr std::array<double, 33 * 33> D_real{3.414999999999848e+02, -4.153450622318861e+02,  1.040868689198174e+02, -4.644718053447573e+01,  2.627414236908814e+01, -1.693785073969950e+01,  1.186729602491864e+01, -8.810978433275912e+00,  6.828427124746193e+00, -5.470359031630041e+00,  4.500148614231352e+00, -3.783555909191678e+00,  3.239828808843551e+00, -2.818031309036683e+00,  2.484750841870328e+00, -2.217337035352033e+00,  2.000000000000000e+00, -1.821465190789022e+00,  1.673513677715992e+00, -1.550045532785609e+00,  1.446462692171690e+00, -1.359252708629945e+00,  1.285702154455406e+00, -1.223695679233927e+00,  1.171572875253810e+00, -1.128024934205407e+00,  1.092019210455573e+00, -1.062743717225881e+00,  1.039566129896580e+00, -1.022003565198977e+00,  1.009700556535264e+00, -1.002413447368272e+00,  5.000000000000000e-01,
        1.038362655579715e+02, -5.179283109806224e+01, -6.944711493213475e+01,  2.614762519212766e+01, -1.402422378576463e+01,  8.828972551985114e+00, -6.108171526192176e+00,  4.500971175033984e+00, -3.471282740211768e+00,  2.771684364371527e+00, -2.274720270688460e+00,  1.909169395605333e+00, -1.632649611183682e+00,  1.418640842522320e+00, -1.249852510129556e+00,  1.114618957731818e+00, -1.004838572376312e+00,  9.147441384660501e-01, -8.401419496291999e-01,  7.779259443634754e-01, -7.257588423399652e-01,  6.818577930302820e-01, -6.448472040990557e-01,  6.136558012875252e-01, -5.874434521839721e-01,  5.655484254742982e-01, -5.474489500631391e-01,  5.327349679685996e-01, -5.210872930463916e-01,  5.122622619107783e-01, -5.060805560910661e-01,  5.024192861881558e-01, -2.506033618420680e-01,
       -2.602171722995434e+01,  6.944711493213475e+01, -1.288464604541069e+01, -4.193761041581673e+01,  1.757291727188724e+01, -1.011490368189108e+01,  6.697220812257222e+00, -4.812902574598748e+00,  3.653922404800452e+00, -2.886902731171483e+00,  2.351751204838717e+00, -1.963137986923299e+00,  1.671956044409732e+00, -1.448224658226041e+00,  1.272758580572834e+00, -1.132800284247398e+00,  1.019591158208319e+00, -9.269537968970597e-01,  8.504300947672565e-01, -7.867387581426155e-01,  7.334235033304497e-01, -6.886189114970628e-01,  6.508910153042048e-01, -6.191265919060527e-01,  5.924549458797314e-01, -5.701918306373548e-01,  5.517987585658860e-01, -5.368532165292640e-01,  5.250267623045971e-01, -5.160689375590646e-01,  5.097955791041592e-01, -5.060805560910661e-01,  2.524251391338159e-01,
        1.161179513361893e+01, -2.614762519212766e+01,  4.193761041581673e+01, -5.678147121159948e+00, -3.024729899384759e+01,  1.332994372701902e+01, -7.969986724118789e+00,  5.436854452998751e+00, -4.002664901512390e+00,  3.100322868049627e+00, -2.491466088883133e+00,  2.059547283194979e+00, -1.741380894398592e+00,  1.500024768834060e+00, -1.312594319086894e+00,  1.164248451261370e+00, -1.044997229879378e+00,  9.479055058532503e-01, -8.680324549300765e-01,  8.017799431438172e-01, -7.464782454706109e-01,  7.001148532880698e-01, -6.611524049218667e-01,  6.284037410492500e-01, -6.009445224433647e-01,  5.780511250977072e-01, -5.591559145032037e-01,  5.438147166465318e-01, -5.316830265802666e-01,  5.224986149396887e-01, -5.160689375590646e-01,  5.122622619107783e-01, -2.555008912997442e-01,
       -6.568535592272034e+00,  1.402422378576463e+01, -1.757291727188724e+01,  3.024729899384759e+01, -3.154322029898782e+00, -2.383320484336515e+01,  1.082134902552819e+01, -6.628263429747421e+00,  4.613125929752759e+00, -3.454395522094404e+00,  2.715109288253466e+00, -2.210028777968214e+00,  1.847759065022574e+00, -1.578295643822195e+00,  1.372138864844849e+00, -1.210855476005204e+00,  1.082392200292394e+00, -9.785725177282599e-01,  8.936791245572379e-01, -8.236118244606568e-01,  7.653668647301797e-01, -7.167039402705322e-01,  6.759269718368289e-01, -6.417361512689520e-01,  6.131259297527532e-01, -5.893133958739971e-01,  5.696872345621347e-01, -5.537709373808226e-01,  5.411961001461970e-01, -5.316830265802666e-01,  5.250267623045971e-01, -5.210872930463916e-01,  2.598915324741450e-01,
        4.234462684924875e+00, -8.828972551985114e+00,  1.011490368189108e+01, -1.332994372701902e+01,  2.383320484336515e+01, -1.984388377809103e+00, -1.982095648903652e+01,  9.181824935010864e+00, -5.720349835513380e+00,  4.039947319304201e+00, -3.064185199380115e+00,  2.435908046798836e+00, -2.003053326362336e+00,  1.690226774026909e+00, -1.455962360409049e+00,  1.275666206312783e+00, -1.133888069632716e+00,  1.020472302367492e+00, -9.284951180289153e-01,  8.530924170480223e-01, -7.907609410267727e-01,  7.389246275688656e-01, -6.956562886326615e-01,  6.594937712503824e-01, -6.293155132220323e-01,  6.042545376936054e-01, -5.836379857202589e-01,  5.669440348163578e-01, -5.537709373808226e-01,  5.438147166465318e-01, -5.368532165292640e-01,  5.327349679685996e-01, -2.656859293064702e-01,
       -2.966824006229659e+00,  6.108171526192176e+00, -6.697220812257222e+00,  7.969986724118789e+00, -1.082134902552819e+01,  1.982095648903652e+01, -1.346909601807963e+00, -1.710595941056281e+01,  8.040987737463649e+00, -5.074176129845476e+00,  3.624509785411549e+00, -2.777215580808537e+00,  2.228232607651518e+00, -1.847797185838427e+00,  1.571389916774204e+00, -1.363414860829364e+00,  1.202689773870091e+00, -1.075862563041609e+00,  9.741272443714635e-01, -8.914608210635061e-01,  8.236193982231805e-01, -7.675384360559138e-01,  7.209598220069481e-01, -6.821920402042624e-01,  6.499514773733522e-01, -6.232548608108506e-01,  6.013448869350452e-01, -5.836379857202589e-01,  5.696872345621347e-01, -5.591559145032037e-01,  5.517987585658860e-01, -5.474489500631391e-01,  2.730048026138933e-01,
        2.202744608318978e+00, -4.500971175033984e+00,  4.812902574598748e+00, -5.436854452998751e+00,  6.628263429747421e+00, -9.181824935010864e+00,  1.710595941056281e+01, -9.603691873838009e-01, -1.517366129957920e+01,  7.214113560230987e+00, -4.598965170389978e+00,  3.315499081018057e+00, -2.561954326000986e+00,  2.071569511083455e+00, -1.730342906847534e+00,  1.481496158097272e+00, -1.293643566719980e+00,  1.148069254340137e+00, -1.032950314091682e+00,  9.404726601348591e-01, -8.652810336278842e-01,  8.035954853719011e-01, -7.526829271641391e-01,  7.105281685250993e-01, -6.756221579329920e-01,  6.468217833599900e-01, -6.232548608108506e-01,  6.042545376936054e-01, -5.893133958739971e-01,  5.780511250977072e-01, -5.701918306373548e-01,  5.655484254742982e-01, -2.820062335513517e-01,
       -1.707106781186548e+00,  3.471282740211768e+00, -3.653922404800452e+00,  4.002664901512390e+00, -4.613125929752759e+00,  5.720349835513380e+00, -8.040987737463649e+00,  1.517366129957920e+01, -7.071067811865794e-01, -1.375260496252897e+01,  6.599068093449741e+00, -4.242500580375636e+00,  3.082392200292393e+00, -2.399105015224755e+00,  1.953062215265936e+00, -1.641794463279664e+00,  1.414213562373095e+00, -1.242044824748127e+00,  1.108405243654782e+00, -1.002615363844270e+00,  9.176077997076059e-01, -8.485337419156985e-01,  7.919681666405436e-01, -7.454341791172066e-01,  7.071067811865475e-01, -6.756221579329919e-01,  6.499514773733521e-01, -6.293155132220323e-01,  6.131259297527530e-01, -6.009445224433646e-01,  5.924549458797312e-01, -5.874434521839721e-01,  2.928932188134524e-01,
        1.367589757907510e+00, -2.771684364371527e+00,  2.886902731171483e+00, -3.100322868049627e+00,  3.454395522094404e+00, -4.039947319304201e+00,  5.074176129845476e+00, -7.214113560230987e+00,  1.375260496252897e+01, -5.308329190494947e-01, -1.268664414135116e+01,  6.135099278688999e+00, -3.972828210158035e+00,  2.906059249671483e+00, -2.276333387581852e+00,  1.864363304549440e+00, -1.576309246902501e+00,  1.365354678958800e+00, -1.205569335608147e+00,  1.081457590344618e+00, -9.832100015158957e-01,  9.043308232290206e-01, -8.403618981253237e-01,  7.881546234512504e-01, -7.454341791172066e-01,  7.105281685250991e-01, -6.821920402042623e-01,  6.594937712503824e-01, -6.417361512689519e-01,  6.284037410492499e-01, -6.191265919060526e-01,  6.136558012875251e-01, -3.059239198084816e-01,
       -1.125037153557838e+00,  2.274720270688460e+00, -2.351751204838717e+00,  2.491466088883133e+00, -2.715109288253466e+00,  3.064185199380115e+00, -3.624509785411549e+00,  4.598965170389978e+00, -6.599068093449741e+00,  1.268664414135116e+01, -4.018058074719799e-01, -1.188022412304149e+01,  5.784131560155052e+00, -3.769522984829640e+00,  2.774079690644295e+00, -2.185538718842026e+00,  1.799952446272832e+00, -1.530017317922962e+00,  1.332160046630399e+00, -1.182235851389680e+00,  1.065809851741950e+00, -9.737411517240382e-01,  8.999762231364161e-01, -8.403618981253237e-01,  7.919681666405436e-01, -7.526829271641390e-01,  7.209598220069479e-01, -6.956562886326613e-01,  6.759269718368288e-01, -6.611524049218664e-01,  6.508910153042046e-01, -6.448472040990555e-01,  3.214255386138514e-01,
        9.458889772979194e-01, -1.909169395605333e+00,  1.963137986923299e+00, -2.059547283194979e+00,  2.210028777968214e+00, -2.435908046798836e+00,  2.777215580808537e+00, -3.315499081018057e+00,  4.242500580375636e+00, -6.135099278688999e+00,  1.188022412304149e+01, -3.030379000702350e-01, -1.127226638751413e+01,  5.521443477401466e+00, -3.619170407925980e+00,  2.678239543304940e+00, -2.121355371980695e+00,  1.756191831845380e+00, -1.500404226508582e+00,  1.312884864346139e+00, -1.170850273864941e+00,  1.060677685990347e+00, -9.737411517240384e-01,  9.043308232290208e-01, -8.485337419156987e-01,  8.035954853719011e-01, -7.675384360559138e-01,  7.389246275688655e-01, -7.167039402705321e-01,  7.001148532880698e-01, -6.886189114970628e-01,  6.818577930302820e-01, -3.398131771574863e-01,
       -8.099572022108876e-01,  1.632649611183682e+00, -1.671956044409732e+00,  1.741380894398592e+00, -1.847759065022574e+00,  2.003053326362336e+00, -2.228232607651518e+00,  2.561954326000986e+00, -3.082392200292393e+00,  3.972828210158035e+00, -5.784131560155052e+00,  1.127226638751413e+01, -2.241707645839854e-01, -1.082265663430981e+01,  5.330686175733191e+00, -3.512885185138781e+00,  2.613125929752753e+00, -2.080297084720175e+00,  1.730781283187528e+00, -1.485954513602923e+00,  1.306562964876377e+00, -1.170850273864941e+00,  1.065809851741951e+00, -9.832100015158959e-01,  9.176077997076060e-01, -8.652810336278842e-01,  8.236193982231804e-01, -7.907609410267727e-01,  7.653668647301796e-01, -7.464782454706107e-01,  7.334235033304496e-01, -7.257588423399651e-01,  3.616156730429224e-01,
        7.045078272591708e-01, -1.418640842522320e+00,  1.448224658226041e+00, -1.500024768834060e+00,  1.578295643822195e+00, -1.690226774026909e+00,  1.847797185838427e+00, -2.071569511083455e+00,  2.399105015224755e+00, -2.906059249671483e+00,  3.769522984829640e+00, -5.521443477401466e+00,  1.082265663430981e+01, -1.584982220313695e-01, -1.050482455074508e+01,  5.201086028322053e+00, -3.444894196476669e+00,  2.575316299629770e+00, -2.060262686588257e+00,  1.722447098238334e+00, -1.485954513602923e+00,  1.312884864346139e+00, -1.182235851389680e+00,  1.081457590344618e+00, -1.002615363844270e+00,  9.404726601348591e-01, -8.914608210635061e-01,  8.530924170480221e-01, -8.236118244606566e-01,  8.017799431438172e-01, -7.867387581426155e-01,  7.779259443634754e-01, -3.875113831964022e-01,
       -6.211877104675820e-01,  1.249852510129556e+00, -1.272758580572834e+00,  1.312594319086894e+00, -1.372138864844849e+00,  1.455962360409049e+00, -1.571389916774204e+00,  1.730342906847534e+00, -1.953062215265936e+00,  2.276333387581852e+00, -2.774079690644295e+00,  3.619170407925980e+00, -5.330686175733191e+00,  1.050482455074508e+01, -1.014046455192901e-01, -1.030150637514722e+01,  5.125830895483012e+00, -3.411717982193871e+00,  2.562915447741506e+00, -2.060262686588257e+00,  1.730781283187528e+00, -1.500404226508582e+00,  1.332160046630400e+00, -1.205569335608148e+00,  1.108405243654782e+00, -1.032950314091682e+00,  9.741272443714633e-01, -9.284951180289153e-01,  8.936791245572379e-01, -8.680324549300764e-01,  8.504300947672564e-01, -8.401419496291996e-01,  4.183784194289979e-01,
        5.543342588380081e-01, -1.114618957731818e+00,  1.132800284247398e+00, -1.164248451261370e+00,  1.210855476005204e+00, -1.275666206312783e+00,  1.363414860829364e+00, -1.481496158097272e+00,  1.641794463279664e+00, -1.864363304549440e+00,  2.185538718842026e+00, -2.678239543304940e+00,  3.512885185138781e+00, -5.201086028322053e+00,  1.030150637514722e+01, -4.948398057038839e-02, -1.020229723737832e+01,  5.101148618689158e+00, -3.411717982193871e+00,  2.575316299629770e+00, -2.080297084720175e+00,  1.756191831845380e+00, -1.530017317922963e+00,  1.365354678958800e+00, -1.242044824748128e+00,  1.148069254340137e+00, -1.075862563041609e+00,  1.020472302367492e+00, -9.785725177282599e-01,  9.479055058532501e-01, -9.269537968970595e-01,  9.147441384660498e-01, -4.553662976972555e-01,
       -5.000000000000001e-01,  1.004838572376312e+00, -1.019591158208319e+00,  1.044997229879378e+00, -1.082392200292394e+00,  1.133888069632716e+00, -1.202689773870091e+00,  1.293643566719980e+00, -1.414213562373095e+00,  1.576309246902501e+00, -1.799952446272832e+00,  2.121355371980695e+00, -2.613125929752753e+00,  3.444894196476669e+00, -5.125830895483012e+00,  1.020229723737832e+01, -2.664535259100376e-15, -1.020229723737832e+01,  5.125830895483012e+00, -3.444894196476669e+00,  2.613125929752753e+00, -2.121355371980695e+00,  1.799952446272832e+00, -1.576309246902501e+00,  1.414213562373095e+00, -1.293643566719980e+00,  1.202689773870090e+00, -1.133888069632716e+00,  1.082392200292394e+00, -1.044997229879377e+00,  1.019591158208318e+00, -1.004838572376312e+00,  5.000000000000000e-01,
        4.553662976972556e-01, -9.147441384660501e-01,  9.269537968970597e-01, -9.479055058532503e-01,  9.785725177282599e-01, -1.020472302367492e+00,  1.075862563041609e+00, -1.148069254340137e+00,  1.242044824748127e+00, -1.365354678958800e+00,  1.530017317922962e+00, -1.756191831845380e+00,  2.080297084720175e+00, -2.575316299629770e+00,  3.411717982193871e+00, -5.101148618689158e+00,  1.020229723737832e+01,  4.948398057039349e-02, -1.030150637514722e+01,  5.201086028322053e+00, -3.512885185138781e+00,  2.678239543304940e+00, -2.185538718842027e+00,  1.864363304549441e+00, -1.641794463279664e+00,  1.481496158097272e+00, -1.363414860829364e+00,  1.275666206312782e+00, -1.210855476005204e+00,  1.164248451261370e+00, -1.132800284247398e+00,  1.114618957731818e+00, -5.543342588380080e-01,
       -4.183784194289980e-01,  8.401419496291999e-01, -8.504300947672565e-01,  8.680324549300765e-01, -8.936791245572379e-01,  9.284951180289153e-01, -9.741272443714635e-01,  1.032950314091682e+00, -1.108405243654782e+00,  1.205569335608147e+00, -1.332160046630399e+00,  1.500404226508582e+00, -1.730781283187528e+00,  2.060262686588257e+00, -2.562915447741506e+00,  3.411717982193871e+00, -5.125830895483012e+00,  1.030150637514722e+01,  1.014046455192884e-01, -1.050482455074508e+01,  5.330686175733191e+00, -3.619170407925980e+00,  2.774079690644297e+00, -2.276333387581853e+00,  1.953062215265936e+00, -1.730342906847534e+00,  1.571389916774204e+00, -1.455962360409049e+00,  1.372138864844848e+00, -1.312594319086894e+00,  1.272758580572834e+00, -1.249852510129556e+00,  6.211877104675819e-01,
        3.875113831964022e-01, -7.779259443634754e-01,  7.867387581426155e-01, -8.017799431438172e-01,  8.236118244606568e-01, -8.530924170480223e-01,  8.914608210635061e-01, -9.404726601348591e-01,  1.002615363844270e+00, -1.081457590344618e+00,  1.182235851389680e+00, -1.312884864346139e+00,  1.485954513602923e+00, -1.722447098238334e+00,  2.060262686588257e+00, -2.575316299629770e+00,  3.444894196476669e+00, -5.201086028322053e+00,  1.050482455074508e+01,  1.584982220313725e-01, -1.082265663430981e+01,  5.521443477401466e+00, -3.769522984829644e+00,  2.906059249671484e+00, -2.399105015224756e+00,  2.071569511083454e+00, -1.847797185838427e+00,  1.690226774026908e+00, -1.578295643822195e+00,  1.500024768834060e+00, -1.448224658226041e+00,  1.418640842522320e+00, -7.045078272591708e-01,
       -3.616156730429224e-01,  7.257588423399652e-01, -7.334235033304497e-01,  7.464782454706109e-01, -7.653668647301797e-01,  7.907609410267727e-01, -8.236193982231805e-01,  8.652810336278842e-01, -9.176077997076059e-01,  9.832100015158957e-01, -1.065809851741950e+00,  1.170850273864941e+00, -1.306562964876377e+00,  1.485954513602923e+00, -1.730781283187528e+00,  2.080297084720175e+00, -2.613125929752753e+00,  3.512885185138781e+00, -5.330686175733191e+00,  1.082265663430981e+01,  2.241707645839841e-01, -1.127226638751413e+01,  5.784131560155060e+00, -3.972828210158037e+00,  3.082392200292394e+00, -2.561954326000985e+00,  2.228232607651518e+00, -2.003053326362336e+00,  1.847759065022574e+00, -1.741380894398592e+00,  1.671956044409731e+00, -1.632649611183682e+00,  8.099572022108874e-01,
        3.398131771574863e-01, -6.818577930302820e-01,  6.886189114970628e-01, -7.001148532880698e-01,  7.167039402705322e-01, -7.389246275688656e-01,  7.675384360559138e-01, -8.035954853719011e-01,  8.485337419156985e-01, -9.043308232290206e-01,  9.737411517240382e-01, -1.060677685990347e+00,  1.170850273864941e+00, -1.312884864346139e+00,  1.500404226508582e+00, -1.756191831845380e+00,  2.121355371980695e+00, -2.678239543304940e+00,  3.619170407925980e+00, -5.521443477401466e+00,  1.127226638751413e+01,  3.030379000702647e-01, -1.188022412304152e+01,  6.135099278689004e+00, -4.242500580375638e+00,  3.315499081018056e+00, -2.777215580808536e+00,  2.435908046798836e+00, -2.210028777968213e+00,  2.059547283194978e+00, -1.963137986923299e+00,  1.909169395605333e+00, -9.458889772979194e-01,
       -3.214255386138515e-01,  6.448472040990557e-01, -6.508910153042048e-01,  6.611524049218667e-01, -6.759269718368289e-01,  6.956562886326615e-01, -7.209598220069481e-01,  7.526829271641391e-01, -7.919681666405436e-01,  8.403618981253237e-01, -8.999762231364161e-01,  9.737411517240384e-01, -1.065809851741951e+00,  1.182235851389680e+00, -1.332160046630400e+00,  1.530017317922963e+00, -1.799952446272832e+00,  2.185538718842027e+00, -2.774079690644297e+00,  3.769522984829644e+00, -5.784131560155060e+00,  1.188022412304152e+01,  4.018058074719344e-01, -1.268664414135114e+01,  6.599068093449737e+00, -4.598965170389971e+00,  3.624509785411545e+00, -3.064185199380112e+00,  2.715109288253463e+00, -2.491466088883131e+00,  2.351751204838715e+00, -2.274720270688458e+00,  1.125037153557837e+00,
        3.059239198084817e-01, -6.136558012875252e-01,  6.191265919060527e-01, -6.284037410492500e-01,  6.417361512689520e-01, -6.594937712503824e-01,  6.821920402042624e-01, -7.105281685250993e-01,  7.454341791172066e-01, -7.881546234512504e-01,  8.403618981253237e-01, -9.043308232290208e-01,  9.832100015158959e-01, -1.081457590344618e+00,  1.205569335608148e+00, -1.365354678958800e+00,  1.576309246902501e+00, -1.864363304549441e+00,  2.276333387581853e+00, -2.906059249671484e+00,  3.972828210158037e+00, -6.135099278689004e+00,  1.268664414135114e+01,  5.308329190495227e-01, -1.375260496252897e+01,  7.214113560230976e+00, -5.074176129845471e+00,  4.039947319304198e+00, -3.454395522094401e+00,  3.100322868049625e+00, -2.886902731171482e+00,  2.771684364371525e+00, -1.367589757907510e+00,
       -2.928932188134525e-01,  5.874434521839721e-01, -5.924549458797314e-01,  6.009445224433647e-01, -6.131259297527532e-01,  6.293155132220323e-01, -6.499514773733522e-01,  6.756221579329920e-01, -7.071067811865475e-01,  7.454341791172066e-01, -7.919681666405436e-01,  8.485337419156987e-01, -9.176077997076060e-01,  1.002615363844270e+00, -1.108405243654782e+00,  1.242044824748128e+00, -1.414213562373095e+00,  1.641794463279664e+00, -1.953062215265936e+00,  2.399105015224756e+00, -3.082392200292394e+00,  4.242500580375638e+00, -6.599068093449737e+00,  1.375260496252897e+01,  7.071067811865326e-01, -1.517366129957915e+01,  8.040987737463634e+00, -5.720349835513373e+00,  4.613125929752754e+00, -4.002664901512387e+00,  3.653922404800449e+00, -3.471282740211765e+00,  1.707106781186547e+00,
        2.820062335513517e-01, -5.655484254742982e-01,  5.701918306373548e-01, -5.780511250977072e-01,  5.893133958739971e-01, -6.042545376936054e-01,  6.232548608108506e-01, -6.468217833599900e-01,  6.756221579329919e-01, -7.105281685250991e-01,  7.526829271641390e-01, -8.035954853719011e-01,  8.652810336278842e-01, -9.404726601348591e-01,  1.032950314091682e+00, -1.148069254340137e+00,  1.293643566719980e+00, -1.481496158097272e+00,  1.730342906847534e+00, -2.071569511083454e+00,  2.561954326000985e+00, -3.315499081018056e+00,  4.598965170389971e+00, -7.214113560230976e+00,  1.517366129957915e+01,  9.603691873838476e-01, -1.710595941056281e+01,  9.181824935010864e+00, -6.628263429747421e+00,  5.436854452998751e+00, -4.812902574598748e+00,  4.500971175033984e+00, -2.202744608318978e+00,
       -2.730048026138933e-01,  5.474489500631391e-01, -5.517987585658860e-01,  5.591559145032037e-01, -5.696872345621347e-01,  5.836379857202589e-01, -6.013448869350452e-01,  6.232548608108506e-01, -6.499514773733521e-01,  6.821920402042623e-01, -7.209598220069479e-01,  7.675384360559138e-01, -8.236193982231804e-01,  8.914608210635061e-01, -9.741272443714633e-01,  1.075862563041609e+00, -1.202689773870090e+00,  1.363414860829364e+00, -1.571389916774204e+00,  1.847797185838427e+00, -2.228232607651518e+00,  2.777215580808536e+00, -3.624509785411545e+00,  5.074176129845471e+00, -8.040987737463634e+00,  1.710595941056281e+01,  1.346909601807954e+00, -1.982095648903652e+01,  1.082134902552819e+01, -7.969986724118789e+00,  6.697220812257222e+00, -6.108171526192176e+00,  2.966824006229659e+00,
        2.656859293064702e-01, -5.327349679685996e-01,  5.368532165292640e-01, -5.438147166465318e-01,  5.537709373808226e-01, -5.669440348163578e-01,  5.836379857202589e-01, -6.042545376936054e-01,  6.293155132220323e-01, -6.594937712503824e-01,  6.956562886326613e-01, -7.389246275688655e-01,  7.907609410267727e-01, -8.530924170480221e-01,  9.284951180289153e-01, -1.020472302367492e+00,  1.133888069632716e+00, -1.275666206312782e+00,  1.455962360409049e+00, -1.690226774026908e+00,  2.003053326362336e+00, -2.435908046798836e+00,  3.064185199380112e+00, -4.039947319304198e+00,  5.720349835513373e+00, -9.181824935010864e+00,  1.982095648903652e+01,  1.984388377809111e+00, -2.383320484336515e+01,  1.332994372701902e+01, -1.011490368189108e+01,  8.828972551985114e+00, -4.234462684924875e+00,
       -2.598915324741450e-01,  5.210872930463916e-01, -5.250267623045971e-01,  5.316830265802666e-01, -5.411961001461970e-01,  5.537709373808226e-01, -5.696872345621347e-01,  5.893133958739971e-01, -6.131259297527530e-01,  6.417361512689519e-01, -6.759269718368288e-01,  7.167039402705321e-01, -7.653668647301796e-01,  8.236118244606566e-01, -8.936791245572379e-01,  9.785725177282599e-01, -1.082392200292394e+00,  1.210855476005204e+00, -1.372138864844848e+00,  1.578295643822195e+00, -1.847759065022574e+00,  2.210028777968213e+00, -2.715109288253463e+00,  3.454395522094401e+00, -4.613125929752754e+00,  6.628263429747421e+00, -1.082134902552819e+01,  2.383320484336515e+01,  3.154322029898773e+00, -3.024729899384759e+01,  1.757291727188724e+01, -1.402422378576463e+01,  6.568535592272034e+00,
        2.555008912997442e-01, -5.122622619107783e-01,  5.160689375590646e-01, -5.224986149396887e-01,  5.316830265802666e-01, -5.438147166465318e-01,  5.591559145032037e-01, -5.780511250977072e-01,  6.009445224433646e-01, -6.284037410492499e-01,  6.611524049218664e-01, -7.001148532880698e-01,  7.464782454706107e-01, -8.017799431438172e-01,  8.680324549300764e-01, -9.479055058532501e-01,  1.044997229879377e+00, -1.164248451261370e+00,  1.312594319086894e+00, -1.500024768834060e+00,  1.741380894398592e+00, -2.059547283194978e+00,  2.491466088883131e+00, -3.100322868049625e+00,  4.002664901512387e+00, -5.436854452998751e+00,  7.969986724118789e+00, -1.332994372701902e+01,  3.024729899384759e+01,  5.678147121159944e+00, -4.193761041581673e+01,  2.614762519212766e+01, -1.161179513361893e+01,
       -2.524251391338159e-01,  5.060805560910661e-01, -5.097955791041592e-01,  5.160689375590646e-01, -5.250267623045971e-01,  5.368532165292640e-01, -5.517987585658860e-01,  5.701918306373548e-01, -5.924549458797312e-01,  6.191265919060526e-01, -6.508910153042046e-01,  6.886189114970628e-01, -7.334235033304496e-01,  7.867387581426155e-01, -8.504300947672564e-01,  9.269537968970595e-01, -1.019591158208318e+00,  1.132800284247398e+00, -1.272758580572834e+00,  1.448224658226041e+00, -1.671956044409731e+00,  1.963137986923299e+00, -2.351751204838715e+00,  2.886902731171482e+00, -3.653922404800449e+00,  4.812902574598748e+00, -6.697220812257222e+00,  1.011490368189108e+01, -1.757291727188724e+01,  4.193761041581673e+01,  1.288464604541071e+01, -6.944711493213475e+01,  2.602171722995434e+01,
        2.506033618420680e-01, -5.024192861881558e-01,  5.060805560910661e-01, -5.122622619107783e-01,  5.210872930463916e-01, -5.327349679685996e-01,  5.474489500631391e-01, -5.655484254742982e-01,  5.874434521839721e-01, -6.136558012875251e-01,  6.448472040990555e-01, -6.818577930302820e-01,  7.257588423399651e-01, -7.779259443634754e-01,  8.401419496291996e-01, -9.147441384660498e-01,  1.004838572376312e+00, -1.114618957731818e+00,  1.249852510129556e+00, -1.418640842522320e+00,  1.632649611183682e+00, -1.909169395605333e+00,  2.274720270688458e+00, -2.771684364371525e+00,  3.471282740211765e+00, -4.500971175033984e+00,  6.108171526192176e+00, -8.828972551985114e+00,  1.402422378576463e+01, -2.614762519212766e+01,  6.944711493213475e+01,  5.179283109806224e+01, -1.038362655579715e+02,
       -5.000000000000000e-01,  1.002413447368272e+00, -1.009700556535264e+00,  1.022003565198977e+00, -1.039566129896580e+00,  1.062743717225881e+00, -1.092019210455573e+00,  1.128024934205407e+00, -1.171572875253810e+00,  1.223695679233926e+00, -1.285702154455406e+00,  1.359252708629945e+00, -1.446462692171689e+00,  1.550045532785609e+00, -1.673513677715992e+00,  1.821465190789022e+00, -2.000000000000000e+00,  2.217337035352032e+00, -2.484750841870328e+00,  2.818031309036683e+00, -3.239828808843550e+00,  3.783555909191678e+00, -4.500148614231349e+00,  5.470359031630038e+00, -6.828427124746189e+00,  8.810978433275912e+00, -1.186729602491864e+01,  1.693785073969950e+01, -2.627414236908814e+01,  4.644718053447573e+01, -1.040868689198174e+02,  4.153450622318861e+02, -3.414999999999848e+02};

TEST(riccati, chebyshev_chebyshev_truth) {
  constexpr Eigen::Index n = 32;
  auto chebyshev_pair = riccati::chebyshev<double>(n);
  Eigen::VectorXd x_truth(n + 1);
  x_truth << 1.00000000e+00,  9.95184727e-01,  9.80785280e-01,  9.56940336e-01,
        9.23879533e-01,  8.81921264e-01,  8.31469612e-01,  7.73010453e-01,
        7.07106781e-01,  6.34393284e-01,  5.55570233e-01,  4.71396737e-01,
        3.82683432e-01,  2.90284677e-01,  1.95090322e-01,  9.80171403e-02,
        6.12323400e-17, -9.80171403e-02, -1.95090322e-01, -2.90284677e-01,
       -3.82683432e-01, -4.71396737e-01, -5.55570233e-01, -6.34393284e-01,
       -7.07106781e-01, -7.73010453e-01, -8.31469612e-01, -8.81921264e-01,
       -9.23879533e-01, -9.56940336e-01, -9.80785280e-01, -9.95184727e-01,
       -1.00000000e+00;
  auto&& x = chebyshev_pair.second;
  for (Eigen::Index i = 0; i < x.size(); ++i) {
    EXPECT_FLOAT_EQ(x(i), x_truth(i));
  }
  Eigen::MatrixXd D_truth(n + 1, n + 1);
  for (int i = 0; i < (n + 1)*(n+1); ++i) {
    D_truth(i) = D_real[i];
  }
  D_truth.transposeInPlace();
  auto&& D = chebyshev_pair.first;
  for (Eigen::Index j = 0; j < D_truth.cols(); ++j) {
    for (Eigen::Index i = 0; i < D_truth.rows(); ++i) {
      EXPECT_NEAR(D_truth(i, j), D(i, j), 1e-10) << "for index: (" << i << ", " << j << ")";
    }
  }
}

TEST(riccati, chebyshev_integration_truth) {
  constexpr Eigen::Index n = 16;
  Eigen::MatrixXd truth(n+1, n+1);
  truth << 2.08333333e-03,  4.10451734e-02,  7.18058610e-02,  1.12582023e-01,  1.35279998e-01,  1.66849135e-01,  1.77797314e-01,  1.96190335e-01,  1.92733655e-01,  1.96190335e-01,  1.77797314e-01,  1.66849135e-01,  1.35279998e-01,  1.12582023e-01,  7.18058610e-02,  4.10451734e-02,  2.08333333e-03,
       -3.88623467e-03,  2.50139862e-02,  7.67778086e-02,  1.08382591e-01,  1.39234759e-01,  1.63003529e-01,  1.81584810e-01,  1.92437332e-01,  1.96464639e-01,  1.92474128e-01,  1.81503271e-01,  1.63150422e-01,  1.38973574e-01,  1.08892024e-01,  7.54935024e-02,  3.73588737e-02,  3.92626533e-03,
        2.00404118e-03, -6.11863403e-03,  3.94992408e-02,  1.17474394e-01,  1.32996985e-01,  1.68194227e-01,  1.76907188e-01,  1.96823455e-01,  1.92259806e-01,  1.96559329e-01,  1.77500126e-01,  1.67096023e-01,  1.35068550e-01,  1.12768898e-01,  7.16351300e-02,  4.12067333e-02,  2.00404118e-03,
       -3.73069751e-03,  8.31398530e-03, -1.24766389e-02,  5.97306492e-02,  1.46579843e-01,  1.59536020e-01,  1.83661264e-01,  1.91040450e-01,  1.97474077e-01,  1.91706705e-01,  1.82110665e-01,  1.62652447e-01,  1.39395751e-01,  1.08521782e-01,  7.58299002e-02,  3.70416071e-02,  4.08180249e-03,
        1.77823623e-03, -4.00473941e-03,  5.74986236e-03, -1.13101805e-02,  7.04592232e-02,  1.77319249e-01,  1.72657069e-01,  1.99359592e-01,  1.90551092e-01,  1.97800046e-01,  1.76549577e-01,  1.67856652e-01,  1.34435551e-01,  1.13316274e-01,  7.11427641e-02,  4.16682774e-02,  1.77823623e-03,
       -3.44330233e-03,  7.15306631e-03, -8.09506995e-03,  1.03750827e-02, -1.69897084e-02,  8.56935058e-02,  1.94071635e-01,  1.86286043e-01,  2.00280435e-01,  1.89825643e-01,  1.83475822e-01,  1.61602232e-01,  1.40244126e-01,  1.07804474e-01,  7.64648188e-02,  3.64522318e-02,  4.36919767e-03,
        1.44029524e-03, -3.05046328e-03,  3.62123321e-03, -4.83890999e-03,  7.47426355e-03, -1.48398185e-02,  9.04318501e-02,  2.10581032e-01,  1.85538951e-01,  2.00714558e-01,  1.74613889e-01,  1.69256527e-01,  1.33355353e-01,  1.14198636e-01,  7.03808615e-02,  4.23648783e-02,  1.44029524e-03,
       -3.06780242e-03,  6.24759103e-03, -6.61282588e-03,  7.33986886e-03, -8.71088106e-03,  1.15500421e-02, -1.93459631e-02,  9.88894064e-02,  2.11834513e-01,  1.84790573e-01,  1.86349657e-01,  1.59717437e-01,  1.41600046e-01,  1.06753440e-01,  7.73385581e-02,  3.56719639e-02,  4.74469758e-03,
        1.04166667e-03, -2.15881519e-03,  2.40031475e-03, -2.86086310e-03,  3.66367107e-03, -5.10246909e-03,  8.01618757e-03, -1.59319399e-02,  9.63668276e-02,  2.12122275e-01,  1.69781126e-01,  1.71951604e-01,  1.31616327e-01,  1.15442886e-01,  6.94055462e-02,  4.32039886e-02,  1.04166667e-03,
       -2.66136425e-03,  5.37320949e-03, -5.53269718e-03,  5.82858325e-03, -6.32004849e-03,  7.13169787e-03, -8.55234372e-03,  1.13997621e-02, -1.91008576e-02,  9.73009288e-02,  1.97143277e-01,  1.55299093e-01,  1.43990879e-01,  1.05242154e-01,  7.84186868e-02,  3.47975824e-02,  5.15113575e-03,
        6.43038091e-04, -1.31970491e-03,  1.42499944e-03, -1.61661316e-03,  1.92464450e-03, -2.40739247e-03,  3.18342451e-03, -4.52422299e-03,  7.19470423e-03, -1.43906964e-02,  8.73654635e-02,  1.81688953e-01,  1.27805734e-01,  1.17420933e-01,  6.81846277e-02,  4.40956367e-02,  6.43038091e-04,
       -2.28586434e-03,  4.59294161e-03, -4.65895788e-03,  4.77754884e-03, -4.96412822e-03,  5.24690285e-03, -5.67850844e-03,  6.36469207e-03, -7.54677933e-03,  9.90429195e-03, -1.62743216e-02,  8.11556291e-02,  1.52269706e-01,  1.02206940e-01,  7.99009309e-02,  3.38921071e-02,  5.52663566e-03,
        3.05097103e-04, -6.23104007e-04,  6.63096839e-04, -7.34250890e-04,  8.44446771e-04, -1.00751730e-03,  1.24773680e-03, -1.60971032e-03,  2.18256296e-03, -3.16925660e-03,  5.14024501e-03, -1.04701143e-02,  6.48207746e-02,  1.23892204e-01,  6.60559986e-02,  4.50499128e-02,  3.05097103e-04,
       -1.99846915e-03,  4.00356636e-03, -4.02403926e-03,  4.06024162e-03, -4.11575314e-03,  4.19668745e-03, -4.31335140e-03,  4.48362999e-03, -4.74042186e-03,  5.14988540e-03, -5.86395058e-03,  7.31311450e-03, -1.12998450e-02,  5.28513739e-02,  8.42824998e-02,  3.27311881e-02,  5.81403085e-03,
        7.92921536e-05, -1.61559921e-04,  1.70730993e-04, -1.86874479e-04,  2.11447331e-04, -2.46887802e-04,  2.97187602e-04, -3.68994174e-04,  4.73849578e-04, -6.33119616e-04,  8.90126055e-04, -1.34509256e-03,  2.28301325e-03, -4.89237070e-03,  3.23066202e-02,  4.71638075e-02,  7.92921536e-05,
       -1.84293200e-03,  3.68629973e-03, -3.68764147e-03,  3.68999884e-03, -3.69357632e-03,  3.69871313e-03, -3.70595774e-03,  3.71620767e-03, -3.73098351e-03,  3.75300297e-03, -3.78749645e-03,  3.84560586e-03, -3.95476110e-03,  4.19943235e-03, -4.97194762e-03,  1.60311873e-02,  5.96956800e-03,
        0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00,  0.00000000e+00;
  auto Im = riccati::integration_matrix<double>(n + 1);
  for (Eigen::Index j = 0; j < truth.cols(); ++j) {
    for (Eigen::Index i = 0; i < truth.rows(); ++i) {
      EXPECT_FLOAT_EQ(truth(i,j), Im(i,j));
    }
  }
}

TEST(riccati, chebyshev_integration) {
  constexpr Eigen::Index n = 32;
  constexpr double a = 3.0;
  auto f = [a](auto x) { return riccati::test::sin(a * x.array() + 1.0).matrix().eval();};
  auto df = [a](auto x) { return (a * riccati::test::cos(a * x.array() + 1.0)).matrix().eval();};
  auto chebyshev_pair = riccati::chebyshev<double>(n);
  auto dfs = df(chebyshev_pair.second);
  auto fs = f(chebyshev_pair.second);
  fs.array() -= fs.coeff(fs.size() - 1);
  auto Im = riccati::integration_matrix<double>(n + 1);
  auto fs_est = Im * dfs;
  auto maxerr = ((fs_est - fs).array() / fs.array()).abs().maxCoeff();
  EXPECT_NEAR(maxerr, 0.0, 1e-8);
}

